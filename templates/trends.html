{% extends "base.html" %}

{% block title %}Trends - Health Tracker{% endblock %}

{% block extra_styles %}
<style>
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 968px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸ“ˆ Trends</h1>
    <p>Track your fitness journey</p>
</div>

<div class="charts-grid">
    <div class="chart">
        <h2>Weight Trend</h2>
        <div id="weightChart"></div>
    </div>

    <div class="chart">
        <h2>Body Fat Trend</h2>
        <div id="bodyFatChart"></div>
    </div>
</div>

<div class="charts-grid">
    <div class="chart">
        <h2>Daily Steps</h2>
        <div id="stepsChart"></div>
    </div>

    <div class="chart">
        <h2>Sleep Total</h2>
        <div id="sleepChart"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadCharts() {
        try {
            const res = await fetch('/api/entries');
            const entries = await res.json();

            entries.sort((a, b) => new Date(a.date) - new Date(b.date));

            const dates = entries.map(e => e.date);

            // Calculate 7-day moving average
            function calculateMovingAverage(data, windowSize = 7) {
                const result = [];
                for (let i = 0; i < data.length; i++) {
                    if (i < windowSize - 1) {
                        result.push(null); // Not enough data points yet
                    } else {
                        const window = data.slice(i - windowSize + 1, i + 1);
                        const validValues = window.filter(v => v != null);
                        const avg = validValues.length ? validValues.reduce((a, b) => a + b, 0) / validValues.length : null;
                        result.push(avg);
                    }
                }
                return result;
            }

            // Time range selector configuration
            function makeTimeRangeXAxis() {
                return {
                    type: 'date',
                    tickangle: -45,
                    gridcolor: '#3a3a3a',
                    rangeselector: {
                        bgcolor: '#1a1a1a',
                        activecolor: '#8b5cf6',
                        font: { color: '#e0e0e0' },
                        buttons: [
                            { count: 30, label: 'Last 30 days', step: 'day', stepmode: 'backward' },
                            { count: 90, label: 'Last 90 days', step: 'day', stepmode: 'backward' },
                            { step: 'all', label: 'All' }
                        ]
                    },
                    rangeslider: { visible: false }
                };
            }

            // Common layout config for dark theme
            const baseLayout = {
                paper_bgcolor: '#252525',
                plot_bgcolor: '#1a1a1a',
                font: { color: '#e0e0e0' },
                hovermode: 'x unified',
                showlegend: false,
                legend: {
                    x: 0.6,
                    y: 1.2,
                    bgcolor: 'rgba(37, 37, 37, 0.8)',
                    bordercolor: '#3a3a3a',
                    borderwidth: 1
                },
                margin: { t: 20, r: 20, b: 60, l: 60 }
            };

            //*******************************
            // Weight Chart
            //*******************************
            const weightData = entries.map(e => e.weight);
            const weightMovingAvg = calculateMovingAverage(weightData, 7);

            Plotly.react('weightChart', [
                {
                    x: dates,
                    y: weightData,
                    name: 'Daily Weight',
                    type: 'scatter',
                    mode: 'markers',
                    marker: {
                        color: '#8b4513',
                        size: 6,
                        opacity: 0.5
                    }
                },
                {
                    x: dates,
                    y: weightMovingAvg,
                    name: '7-Day Average',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'brown',
                        width: 3
                    }
                }
            ], {
                ...baseLayout,
                yaxis: {
                    title: 'Weight (kg)',
                    gridcolor: '#3a3a3a'
                },
                xaxis: makeTimeRangeXAxis()
            }, {
                responsive: true,
                displaylogo: false
            });

            //*******************************
            // Body Fat Chart
            //*******************************
            const bodyFatData = entries.map(e => e.body_fat);
            const bodyFatMovingAvg = calculateMovingAverage(bodyFatData, 7);

            Plotly.react('bodyFatChart', [
                {
                    x: dates,
                    y: bodyFatData,
                    name: 'Daily Body Fat',
                    type: 'scatter',
                    mode: 'markers',
                    marker: {
                        color: '#ff6b35',
                        size: 6,
                        opacity: 0.5
                    }
                },
                {
                    x: dates,
                    y: bodyFatMovingAvg,
                    name: '7-Day Average',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: '#ff6b35',
                        width: 3
                    }
                }
            ], {
                ...baseLayout,
                yaxis: {
                    title: 'Body Fat (%)',
                    gridcolor: '#3a3a3a'
                },
                xaxis: makeTimeRangeXAxis()
            }, {
                responsive: true,
                displaylogo: false
            });

            //*******************************
            // Steps Chart
            //*******************************
            const stepsData = entries.map(e => e.steps);
            const stepsMovingAvg = calculateMovingAverage(stepsData, 7);

            Plotly.react('stepsChart', [
                {
                    x: dates,
                    y: stepsData,
                    name: 'Daily Steps',
                    type: 'bar',
                    marker: {
                        color: '#43e97b',
                        opacity: 0.6
                    }
                },
                {
                    x: dates,
                    y: stepsMovingAvg,
                    name: '7-Day Average',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: '#006400',
                        width: 3
                    }
                }
            ], {
                ...baseLayout,
                yaxis: {
                    title: 'Steps',
                    gridcolor: '#3a3a3a'
                },
                xaxis: makeTimeRangeXAxis()
            }, {
                responsive: true,
                displaylogo: false
            });

            //*******************************
            // Sleep Chart
            //*******************************
            const sleepData = entries.map(e => e.sleep_total);
            const sleepMovingAvg = calculateMovingAverage(sleepData, 7);

            Plotly.react('sleepChart', [
                {
                    x: dates,
                    y: sleepData,
                    name: 'Daily Sleep',
                    type: 'bar',
                    marker: {
                        color: '#4facfe',
                        opacity: 0.5
                    }
                },
                {
                    x: dates,
                    y: sleepMovingAvg,
                    name: '7-Day Average',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: '#4f55fe',
                        width: 3
                    }
                }
            ], {
                ...baseLayout,
                yaxis: {
                    title: 'Sleep Time (hours)',
                    gridcolor: '#3a3a3a'
                },
                xaxis: makeTimeRangeXAxis()
            }, {
                responsive: true,
                displaylogo: false
            });

        } catch (error) {
            console.error('Error loading charts:', error);
        }
    }

    // Load charts on page load
    loadCharts();
</script>
{% endblock %}