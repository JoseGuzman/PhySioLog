{% extends "base.html" %}

{% block title %}Overview - Physiolog{% endblock %}

{% block extra_styles %}
<style>
    .overview-grid {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: 16px;
        align-items: start;
    }

    @media (max-width: 1100px) {
        .overview-grid {
            grid-template-columns: 1fr;
        }
    }

    .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px;
    }

    .panel h2 {
        font-size: 1.05em;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .panel small {
        color: var(--muted);
    }

    .inputs-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .inputs-grid .full {
        grid-column: 1 / -1;
    }

    /* Results blocks (blue/green/orange like your sheet) */
    .results-grid {
        display: grid;
        gap: 14px;
    }

    .result-block {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 14px;
    }

    .result-block.blue {
        background: rgba(56, 189, 248, 0.10);
        border-color: rgba(56, 189, 248, 0.25);
    }

    .result-block.green {
        background: rgba(34, 197, 94, 0.10);
        border-color: rgba(34, 197, 94, 0.25);
    }

    .result-block.orange {
        background: rgba(251, 146, 60, 0.10);
        border-color: rgba(251, 146, 60, 0.25);
    }

    .result-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 10px 0;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .result-row:first-of-type {
        border-top: 0;
    }

    .result-label {
        color: var(--muted);
        font-weight: 650;
    }

    .result-value {
        font-weight: 800;
        letter-spacing: -0.01em;
    }

    .result-big {
        font-size: 1.4em;
    }

    .minmax {
        display: flex;
        gap: 12px;
        color: var(--muted);
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Overview</h1>
    <p>All values are estimates and should be interpreted in context. </p>
</div>

<div class="overview-grid">

    <!-- LEFT: Inputs -->
    <div class="panel">
        <h2>User Metrics</h2>
        <small>Your profile will be updated when you press Calculate.</small>

        <form id="tdeeForm" style="margin-top: 14px;">
            <div class="inputs-grid">
                <div>
                    <label>Age (years)</label>
                    <input type="number" id="age" min="0" step="1" placeholder="--">
                </div>

                <div>
                    <label>Height (cm)</label>
                    <input type="number" id="height" min="0" step="1" placeholder="--">
                </div>

                <div>
                    <label>Weight (kg)</label>
                    <input type="number" id="tdeeWeight" min="0" step="0.1" placeholder="--">
                </div>

                <div>
                    <label>Gender</label>
                    <select id="gender">
                        <option value="male" selected>Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>

                <div class="full">
                    <label>Activity</label>
                    <select id="activity">
                        <option value="1.2">Sedentary (0–1 days/week): 1.2</option>
                        <option value="1.375">Light (2–3 days/week): 1. 375</option>
                        <option value="1.55" selected>Moderate (3–5 days/week): 1.55</option>
                        <option value="1.7">High (6–7 days/week): 1.7 </option>
                        <option value="1.9">Very high (2x/day): 1.9</option>
                    </select>
                </div>

                <div class="full">
                    <button type="button" id="recalcBtn">Calculate</button>
                </div>
            </div>
        </form>
    </div>

    <!-- RIGHT: Results -->
    <div class="results-grid">

        <!-- BMR / TDEE -->
        <div class="result-block blue">
            <h2 style="margin-bottom: 6px;">Metabolism</h2>

            <div class="result-row">
                <div class="result-label">Basal Metabolic Rate (BMR)</div>
                <div class="result-value result-big"><span id="bmrOut">—</span> kcal</div>
            </div>

            <div class="result-row">
                <div class="result-label">
                    Total Daily Energy Expenditure (TDEE)
                    <div class="minmax">
                        <span>min: <span id="tdeeMinOut">—</span> kcal</span>
                        <span>max: <span id="tdeeMaxOut">—</span> kcal</span>
                    </div>
                </div>
                <div class="result-value result-big"><span id="tdeeOut">—</span> kcal</div>
            </div>

        </div>

        <!-- Weight loss -->
        <div class="result-block green">
            <h2 style="margin-bottom: 6px;">Weight Loss</h2>

            <div class="result-row">
                <div class="result-label">
                    Calories (deficit)
                    <div class="minmax">
                        <span>min: <span id="cutMinOut">—</span> kcal</span>
                        <span>max: <span id="cutMaxOut">—</span> kcal</span>
                    </div>
                </div>
                <div class="result-value result-big"><span id="cutCaloriesOut">—</span> kcal</div>
            </div>

            <div class="result-row">
                <div class="result-label">
                    Protein (per day)
                    <div class="minmax">
                        <span>min: <span id="cutProteinMinOut">—</span> g</span>
                        <span>max: <span id="cutProteinMaxOut">—</span> g</span>
                    </div>
                </div>


                <div class="result-value result-big"><span id="cutProteinOut">—</span> g</div>
            </div>
        </div>

        <!-- Lean bulk -->
        <div class="result-block orange">
            <h2 style="margin-bottom: 6px;">Lean Bulk</h2>

            <div class="result-row">
                <div class="result-label">
                    Calories (surplus per day)
                    <div class="minmax">
                        <span>min: <span id="bulkMinOut">—</span> kcal</span>
                        <span>max: <span id="bulkMaxOut">—</span> kcal</span>
                    </div>
                </div>
                <div class="result-value result-big"><span id="bulkCaloriesOut">—</span> kcal</div>
            </div>

            <div class="result-row">
                <div class="result-label">
                    Protein (per day)
                    <div class="minmax">
                        <span>min: <span id="bulkProteinMinOut">—</span> g</span>
                        <span>max: <span id="bulkProteinMaxOut">—</span> g</span>
                    </div>
                </div>
                <div class="result-value result-big"><span id="bulkProteinOut">—</span> g</div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function setText(id, val) {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    }

    function clearCalcOutputs() {
        const ids = [
            "bmrOut", "tdeeOut", "tdeeMinOut", "tdeeMaxOut",
            "cutCaloriesOut", "cutMinOut", "cutMaxOut",
            "cutProteinOut", "cutProteinMinOut", "cutProteinMaxOut",
            "bulkCaloriesOut", "bulkMinOut", "bulkMaxOut",
            "bulkProteinOut", "bulkProteinMinOut", "bulkProteinMaxOut",
        ];
        ids.forEach((id) => setText(id, "--"));
    }

    function parseMaybeNumber(raw) {
        const value = String(raw ?? "").trim();
        if (!value || value === "--") return null;
        const n = parseFloat(value);
        return Number.isFinite(n) && n > 0 ? n : null;
    }

    async function loadUserProfile() {
        const res = await fetch("/api/user-profile");
        if (!res.ok) return;
        const body = await res.json();
        const p = body?.profile || {};
        document.getElementById("age").value = p.age ?? "";
        document.getElementById("height").value = p.height_cm ?? "";
        document.getElementById("tdeeWeight").value = p.weight_kg ?? "";
    }

    async function persistUserProfile(age, height, weight) {
        await fetch("/api/user-profile", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ age, height_cm: height, weight_kg: weight }),
        });
    }

    /* Basal Metabolic Rate (BMR) 
    Harris-Benedict Equation
    */
    function calculateBMR(weight, height, age, gender) {
        if (gender === 'male') {
            return (10 * weight) + (6.25 * height) - (5 * age) + 5;
        } else {
            return (10 * weight) + (6.25 * height) - (5 * age) - 161;
        }
    }

    function round(n) {
        return Math.round(n);
    }

    function recalc() {

        // for MBR calculation 
        const age = parseMaybeNumber(document.getElementById('age').value);
        const height = parseMaybeNumber(document.getElementById('height').value);
        const weight = parseMaybeNumber(document.getElementById('tdeeWeight').value);
        const gender = document.getElementById('gender').value;
        // for TDEE calculation 
        const activity = parseFloat(document.getElementById('activity').value);

        if (age === null || height === null || weight === null) {
            clearCalcOutputs();
            alert("Please enter valid Age, Height, and Weight before recalculating.");
            return;
        }

        persistUserProfile(age, height, weight).catch(() => { });

        // ---- BMR ----
        const bmr = calculateBMR(weight, height, age, gender);

        // Total Daily Energy Expenditure is BMR * activity
        const tdee = bmr * activity;

        // ---- Display ----
        setText('bmrOut', round(bmr));
        setText('tdeeOut', round(tdee));

        setText('activityOut', activity.toFixed(2));

        // Simple range (+/- 2.5%)
        const min = tdee * 0.95;
        const max = tdee * 1.05;

        setText('tdeeMinOut', round(min));
        setText('tdeeMaxOut', round(max));

        // Weight Loss suggestions
        // −10–15 % TDEE
        // Protein 2.0 – 2.4 g/kg per day
        setText('cutCaloriesOut', round(tdee * 0.875));
        setText('cutMinOut', round(tdee * 0.85));
        setText('cutMaxOut', round(tdee * 0.90));
        setText('cutProteinOut', round(weight * 2.2));
        setText('cutProteinMinOut', round(weight * 2.0));
        setText('cutProteinMaxOut', round(weight * 2.4));

        // Lean Bulk
        // +5–10 % over TDEE
        // Protein 1.6 – 2.2 g/kg per day
        setText('bulkCaloriesOut', round(tdee * 1.075));
        setText('bulkMinOut', round(tdee * 1.05));
        setText('bulkMaxOut', round(tdee * 1.10));
        setText('bulkProteinOut', round(weight * 2.0));
        setText('bulkProteinMinOut', round(weight * 1.6));
        setText('bulkProteinMaxOut', round(weight * 2.2));
    }

    // listeners
    document.getElementById('recalcBtn')?.addEventListener('click', recalc);
    document.addEventListener('DOMContentLoaded', async () => {
        clearCalcOutputs();
        await loadUserProfile();
        recalc();
    });

</script>
{% endblock %}